{% extends "base.html" %}
{% block title %}Dashboard â€“ Uknowme{% endblock %}

{% block content %}
<div class="dashboard-page">
  <div class="card shadow-sm mb-4 dashboard-hero">
    <div class="card-body">
      <div class="dashboard-hero-head">
        <h4 class="fw-bold mb-1 dashboard-title">Your Anonymous Inbox</h4>
        <p class="text-muted mb-0 dashboard-subtitle">
          Share your link to receive honest anonymous feedback.
        </p>
      </div>
      <div class="input-group mt-3">
        <input
          id="inboxLinkInput"
          class="form-control"
          readonly
          value="{{ inbox_link }}"
          aria-label="Your anonymous inbox link"
        >
        <button id="copyInboxBtn" class="btn btn-primary" type="button">
          Copy link
        </button>
      </div>
      <small id="copyInboxStatus" class="text-muted d-block mt-2">Tap copy to share your inbox link.</small>
    </div>
  </div>

  <!-- CONTENT FIRST (required by AdSense) -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Messages</h5>

      {% if messages %}
        {% for msg in messages %}
          <div class="border rounded p-3 mb-2">
            <p class="mb-1">{{ msg.text }}</p>
            <small class="text-muted">{{ msg.created_at.strftime('%d %b %Y') }}</small>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-muted">No messages yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- ADS AFTER CONTENT -->
  <div class="card shadow-sm">
    <div class="card-body text-center">
      <script async
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9988420021358515"
        crossorigin="anonymous"></script>

      <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-9988420021358515"
        data-ad-slot="1234567890"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>

      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>
  </div>
</div>
<script>
(() => {
  const input = document.getElementById("inboxLinkInput");
  const copyBtn = document.getElementById("copyInboxBtn");
  const status = document.getElementById("copyInboxStatus");

  if (!input || !copyBtn || !status) {
    return;
  }

  const updateStatus = (message, isError = false) => {
    status.textContent = message;
    status.classList.remove("text-muted", "text-success", "text-danger");
    status.classList.add(isError ? "text-danger" : "text-success");
    if (!isError) {
      setTimeout(() => {
        status.textContent = "Tap copy to share your inbox link.";
        status.classList.remove("text-success", "text-danger");
        status.classList.add("text-muted");
      }, 2200);
    }
  };

  const fallbackCopy = () => {
    input.focus();
    input.select();
    input.setSelectionRange(0, input.value.length);
    return document.execCommand("copy");
  };

  copyBtn.addEventListener("click", async () => {
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(input.value);
      } else if (!fallbackCopy()) {
        throw new Error("Copy command failed");
      }

      copyBtn.textContent = "Copied";
      updateStatus("Inbox link copied.", false);
      setTimeout(() => {
        copyBtn.textContent = "Copy link";
      }, 1400);
    } catch (err) {
      updateStatus("Could not copy automatically. Select and copy manually.", true);
      input.focus();
      input.select();
    }
  });
})();
</script>
{% endblock %}
