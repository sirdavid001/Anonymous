{% extends "base.html" %}
{% block title %}Dashboard â€“ Uknowme{% endblock %}
{% block head %}
<style>
  .dash-link-wrap {
    margin-top: 0.95rem;
    padding: 0.7rem;
    border-radius: 16px;
    border: 1px solid rgba(37, 99, 235, 0.26);
    background:
      radial-gradient(130% 120% at 0% 0%, rgba(37, 99, 235, 0.12), transparent 60%),
      radial-gradient(110% 130% at 100% 100%, rgba(14, 165, 233, 0.12), transparent 60%),
      var(--card);
  }

  .dash-link-group {
    display: flex;
    align-items: stretch;
    gap: 0.55rem;
  }

  .dash-link-input {
    border: 1px solid rgba(37, 99, 235, 0.28) !important;
    border-radius: 12px !important;
    background: #f8fbff !important;
    color: #1d4ed8 !important;
    font-weight: 600;
  }

  .dash-link-input:focus {
    border-color: rgba(14, 165, 233, 0.7) !important;
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.18) !important;
  }

  .dash-copy-btn {
    width: auto;
    min-width: 124px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, #2563eb, #0ea5e9);
    color: #ffffff;
    font-weight: 700;
    box-shadow: 0 10px 22px rgba(37, 99, 235, 0.28);
  }

  .dash-copy-btn:hover {
    transform: translateY(-1px);
  }

  .dash-link-note {
    margin-top: 0.5rem;
  }

  .dash-share-grid {
    margin-top: 0.75rem;
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 0.55rem;
  }

  .dash-share-btn {
    width: 100%;
    border: 1px solid transparent;
    border-radius: 12px;
    padding: 0.6rem 0.7rem;
    text-decoration: none;
    font-weight: 700;
    text-align: center;
    font-size: 0.88rem;
    cursor: pointer;
  }

  .dash-share-wa {
    color: #ffffff;
    background: linear-gradient(135deg, #16a34a, #22c55e);
    box-shadow: 0 8px 18px rgba(22, 163, 74, 0.28);
  }

  .dash-share-tg {
    color: #ffffff;
    background: linear-gradient(135deg, #0ea5e9, #3b82f6);
    box-shadow: 0 8px 18px rgba(59, 130, 246, 0.26);
  }

  .dash-share-more {
    color: #0f172a;
    background: linear-gradient(135deg, #fde047, #facc15);
    box-shadow: 0 8px 18px rgba(250, 204, 21, 0.32);
  }

  .empty-board {
    border-radius: 14px;
    border: 1px solid rgba(37, 99, 235, 0.2);
    background:
      radial-gradient(120% 120% at 0% 0%, rgba(37, 99, 235, 0.12), transparent 56%),
      radial-gradient(100% 120% at 100% 100%, rgba(14, 165, 233, 0.1), transparent 56%),
      var(--card);
    padding: 1rem;
  }

  .empty-board h6 {
    margin-bottom: 0.45rem;
  }

  @media (max-width: 768px) {
    .dash-link-group {
      flex-direction: column;
    }

    .dash-copy-btn {
      width: 100%;
    }

    .dash-share-grid {
      grid-template-columns: 1fr;
    }
  }

  html[data-theme="dark"] .dash-link-input {
    background: #0c1730 !important;
    color: #93c5fd !important;
    border-color: rgba(56, 189, 248, 0.35) !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-page">
  <div class="card shadow-sm mb-4 dashboard-hero">
    <div class="card-body">
      <div class="dashboard-hero-head">
        <h4 class="fw-bold mb-1 dashboard-title">Your Anonymous Inbox</h4>
        <p class="text-muted mb-0 dashboard-subtitle">
          Share your link to receive honest anonymous feedback.
        </p>
      </div>
      <div class="dash-link-wrap">
        <div class="dash-link-group">
          <input
            id="inboxLinkInput"
            class="form-control dash-link-input"
            readonly
            value="{{ inbox_link }}"
            aria-label="Your anonymous inbox link"
          >
          <button id="copyInboxBtn" class="btn dash-copy-btn" type="button">
            Copy link
          </button>
        </div>
      </div>
      <small id="copyInboxStatus" class="text-muted d-block dash-link-note">Tap copy to share your inbox link.</small>
      <div class="dash-share-grid">
        <a id="shareWhatsAppBtn" class="dash-share-btn dash-share-wa" target="_blank" rel="noopener noreferrer">WhatsApp</a>
        <a id="shareTelegramBtn" class="dash-share-btn dash-share-tg" target="_blank" rel="noopener noreferrer">Telegram</a>
        <button id="shareMoreBtn" class="dash-share-btn dash-share-more" type="button">More options</button>
      </div>
    </div>
  </div>

  <!-- CONTENT FIRST (required by AdSense) -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold mb-0">Messages</h5>
        <button id="refreshBoardBtn" class="btn btn-outline-secondary btn-sm w-auto px-3 py-2" type="button">
          Refresh
        </button>
      </div>

      {% if messages %}
        {% for msg in messages %}
          <div class="border rounded p-3 mb-2">
            <p class="mb-1">{{ msg.text }}</p>
            <small class="text-muted">{{ msg.created_at.strftime('%d %b %Y') }}</small>
          </div>
        {% endfor %}
      {% else %}
        <div class="empty-board">
          <h6 class="fw-bold">No messages yet</h6>
          <p class="text-muted mb-0">Share your link above with friends to start receiving anonymous messages.</p>
        </div>
      {% endif %}
    </div>
  </div>

</div>
<script>
(() => {
  const input = document.getElementById("inboxLinkInput");
  const copyBtn = document.getElementById("copyInboxBtn");
  const status = document.getElementById("copyInboxStatus");
  const shareWhatsAppBtn = document.getElementById("shareWhatsAppBtn");
  const shareTelegramBtn = document.getElementById("shareTelegramBtn");
  const shareMoreBtn = document.getElementById("shareMoreBtn");
  const refreshBoardBtn = document.getElementById("refreshBoardBtn");

  if (!input || !copyBtn || !status || !shareWhatsAppBtn || !shareTelegramBtn || !shareMoreBtn) {
    return;
  }

  const inboxUrl = input.value;
  const shareTitle = "My Uknowme inbox";
  const shareText = "Send me anonymous feedback on Uknowme:";
  const encodedUrl = encodeURIComponent(inboxUrl);
  const encodedText = encodeURIComponent(`${shareText} ${inboxUrl}`);

  shareWhatsAppBtn.href = `https://wa.me/?text=${encodedText}`;
  shareTelegramBtn.href = `https://t.me/share/url?url=${encodedUrl}&text=${encodeURIComponent(shareText)}`;

  const updateStatus = (message, isError = false) => {
    status.textContent = message;
    status.classList.remove("text-muted", "text-success", "text-danger");
    status.classList.add(isError ? "text-danger" : "text-success");
    if (!isError) {
      setTimeout(() => {
        status.textContent = "Tap copy to share your inbox link.";
        status.classList.remove("text-success", "text-danger");
        status.classList.add("text-muted");
      }, 2200);
    }
  };

  const fallbackCopy = () => {
    input.focus();
    input.select();
    input.setSelectionRange(0, input.value.length);
    return document.execCommand("copy");
  };

  const copyInboxLink = async () => {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(inboxUrl);
      return;
    }

    if (!fallbackCopy()) {
      throw new Error("Copy command failed");
    }
  };

  copyBtn.addEventListener("click", async () => {
    try {
      await copyInboxLink();
      copyBtn.textContent = "Copied";
      updateStatus("Inbox link copied.", false);
      setTimeout(() => {
        copyBtn.textContent = "Copy link";
      }, 1400);
    } catch (err) {
      updateStatus("Could not copy automatically. Select and copy manually.", true);
      input.focus();
      input.select();
    }
  });

  shareMoreBtn.addEventListener("click", async () => {
    if (navigator.share) {
      try {
        await navigator.share({
          title: shareTitle,
          text: shareText,
          url: inboxUrl,
        });
        updateStatus("Share sheet opened.", false);
      } catch (err) {
        if (err && err.name !== "AbortError") {
          updateStatus("Could not open share sheet. Link copied instead.", true);
        }
      }
      return;
    }

    try {
      await copyInboxLink();
      updateStatus("Share not supported on this browser. Link copied instead.", false);
    } catch (err) {
      updateStatus("Could not copy automatically. Select and copy manually.", true);
      input.focus();
      input.select();
    }
  });

  if (refreshBoardBtn) {
    refreshBoardBtn.addEventListener("click", () => {
      window.location.reload();
    });
  }
})();
</script>
{% endblock %}
